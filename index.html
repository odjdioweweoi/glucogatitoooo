<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GlucoGatito: Tu Diario de Insulina</title>
    
    <!-- PWA Enhancements -->
    <meta name="theme-color" content="#f87171"/>
    <!-- The manifest link will be added dynamically by JavaScript -->

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Mochiy+Pop+One&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .kawaii-font { font-family: 'Mochiy Pop One', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #fee2e2; }
        ::-webkit-scrollbar-thumb { background: #fca5a5; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #f87171; }
        .animate-bounce-slow { animation: bounce-slow 2s infinite; }
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(-5%); animation-timing-function: cubic-bezier(0.8, 0, 1, 1); }
            50% { transform: translateY(0); animation-timing-function: cubic-bezier(0, 0, 0.2, 1); }
        }
        .calendar-day { transition: all 0.2s ease-in-out; }
        .calendar-day:hover { transform: scale(1.1); background-color: #ffedd5; }
        .has-entry::after {
            content: ''; position: absolute; bottom: 4px; left: 50%;
            transform: translateX(-50%); width: 6px; height: 6px;
            border-radius: 50%; background-color: #f97316;
        }
        @keyframes flash-success {
            0% { background-color: #fef9c3; border-color: #fde047; }
            100% { background-color: #ffffff; border-color: #fcd34d; }
        }
        .flash-success {
            animation: flash-success 0.8s ease-in-out;
        }
    </style>
</head>
<body class="bg-rose-50 min-h-screen p-4 transition-all duration-300">

    <div class="w-full max-w-md mx-auto space-y-6">
        
        <header class="text-center">
            <h1 class="text-4xl kawaii-font text-red-500 drop-shadow-sm">GlucoGatito</h1>
            <p class="text-gray-500 mt-2">Tu diario de diabetes adorable</p>
        </header>

        <!-- Calculator Section -->
        <main class="bg-white rounded-3xl shadow-lg p-6 md:p-8 space-y-6 relative overflow-hidden">
            <h2 class="text-2xl kawaii-font text-gray-700 text-center">A√±adir Registro üìù</h2>
            <div class="space-y-4">
                <div>
                    <label for="currentGlucose" class="block text-sm font-medium text-gray-700 mb-1">ü©∏ Glucosa Actual (mg/dL)</label>
                    <input type="number" id="currentGlucose" class="w-full px-4 py-3 bg-red-50 border-2 border-red-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-400" placeholder="Ej: 180">
                </div>
                <div>
                    <label for="targetGlucose" class="block text-sm font-medium text-gray-700 mb-1">üéØ Glucosa Deseada (mg/dL)</label>
                    <input type="number" id="targetGlucose" value="100" class="w-full px-4 py-3 bg-red-50 border-2 border-red-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-400">
                </div>
                <div>
                    <label for="correctionFactor" class="block text-sm font-medium text-gray-700 mb-1">üìâ Factor de Correcci√≥n</label>
                    <input type="number" id="correctionFactor" class="w-full px-4 py-3 bg-orange-50 border-2 border-orange-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-400" placeholder="1U baja ... mg/dL">
                </div>
                <div>
                    <label for="carbRatio" class="block text-sm font-medium text-gray-700 mb-1">üçö Ratio de Carbohidratos</label>
                    <input type="number" id="carbRatio" class="w-full px-4 py-3 bg-orange-50 border-2 border-orange-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-400" placeholder="1U por ... g CH">
                </div>
                
                <div class="bg-amber-50 p-4 rounded-2xl border-2 border-amber-200 space-y-2">
                     <label class="block text-sm font-medium text-gray-700">üç∞ Comida (Opcional)</label>
                     <div class="flex items-center gap-2">
                        <input type="text" id="foodSearch" class="w-full px-4 py-2 bg-white border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-400" placeholder="Ej: 1 pl√°tano y 2 tostadas">
                        <button id="searchButton" class="bg-amber-400 text-amber-900 font-bold p-2 rounded-lg hover:bg-amber-500 transition-transform transform hover:scale-105 active:scale-95 flex items-center justify-center shrink-0 w-10 h-10">
                            <span id="searchIcon">‚ú®</span>
                            <svg id="searchLoadingIcon" class="animate-spin h-5 w-5 text-amber-900 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                     </div>
                     <div class="grid grid-cols-2 gap-2">
                        <input type="number" id="carbsToEat" class="w-full px-4 py-2 bg-white border-2 border-amber-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-amber-400 transition-colors" placeholder="Total Carbs (g)">
                        <input type="number" id="calories" class="w-full px-4 py-2 bg-white border-2 border-amber-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-amber-400 transition-colors" placeholder="Total Calor√≠as">
                     </div>
                      <div id="foodBreakdown" class="mt-2 space-y-1 text-sm">
                        <!-- Breakdown items will be injected here by JS -->
                      </div>
                     <select id="mealType" class="w-full px-4 py-2 bg-white border-2 border-amber-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-amber-400">
                        <option value="Desayuno">ü•ê Desayuno</option>
                        <option value="Almuerzo">ü•ó Almuerzo</option>
                        <option value="Comida">üçù Comida</option>
                        <option value="Merienda">üç™ Merienda</option>
                        <option value="Cena">üç≤ Cena</option>
                        <option value="Aperitivo">ü•® Aperitivo</option>
                     </select>
                </div>
            </div>
            <button id="calculateButton" class="w-full kawaii-font bg-red-400 text-white py-4 rounded-2xl text-lg font-bold hover:bg-red-500 transition-all duration-300 transform hover:scale-105 active:scale-95 shadow-md">
                A√±adir y Calcular Dosis üêæ
            </button>
        </main>

        <!-- Daily Diary Section -->
        <section id="diarySection" class="bg-white rounded-3xl shadow-lg p-6 md:p-8 space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl kawaii-font text-gray-700">Diario de Hoy</h2>
                <button id="openCalendarButton" class="bg-orange-200 text-orange-700 p-2 rounded-full hover:bg-orange-300 transition-transform transform hover:scale-110">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                </button>
            </div>
            <div id="dailySummary" class="text-center bg-gray-50 p-3 rounded-xl">
                 <p class="text-gray-600">Total Calor√≠as: <span id="totalCalories" class="font-bold text-lg text-red-500">0</span> kcal</p>
            </div>
            <ul id="dailyLog" class="space-y-3"></ul>
            <div class="pt-4 border-t">
                 <label class="block text-sm font-medium text-gray-700 mb-2">üèÉ‚Äç‚ôÄÔ∏è Actividad F√≠sica</label>
                 <div class="flex gap-2">
                    <input type="text" id="activityInput" class="w-full px-4 py-2 bg-gray-50 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-400" placeholder="Ej: 30 min caminando">
                    <button id="addActivityButton" class="bg-orange-400 text-white font-bold p-2 rounded-lg hover:bg-orange-500 transition-transform transform hover:scale-105 active:scale-95 shrink-0">A√±adir</button>
                 </div>
                 <ul id="activityLog" class="mt-3 space-y-2 text-sm text-gray-700"></ul>
            </div>
            <!-- Gemini AI Insight Section -->
            <div class="pt-4 border-t">
                <label class="block text-sm font-medium text-gray-700 mb-2">üíñ An√°lisis del D√≠a</label>
                <button id="analyzeDayButton" class="w-full flex items-center justify-center gap-2 kawaii-font bg-gradient-to-r from-orange-400 to-red-500 text-white py-3 rounded-2xl text-md font-bold hover:from-orange-500 hover:to-red-600 transition-all duration-300 transform hover:scale-105 active:scale-95 shadow-md">
                    <svg id="sparkleIcon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2z"/></svg>
                    <span id="analyzeButtonText">‚ú® Analizar mi d√≠a</span>
                    <svg id="analyzeLoadingIcon" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
            </div>
        </section>

        <!-- Modals -->
        <div id="resultModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4 z-50 hidden opacity-0 transition-opacity duration-300">
            <div id="resultCard" class="bg-white rounded-3xl shadow-2xl p-8 text-center max-w-sm w-full transform scale-95 transition-transform duration-300">
                <img id="resultImage" src="https://placehold.co/120x120/fed7aa/f97316?text=Miau%21" alt="Gatito Feliz" class="mx-auto mb-4 rounded-full animate-bounce-slow">
                <h2 class="text-2xl kawaii-font text-gray-800 mb-2">Dosis Recomendada</h2>
                <p id="resultText" class="text-5xl font-bold text-red-500 my-4">2.5 U</p>
                <p id="resultMessage" class="text-gray-600">¬°Registro guardado! Sigue siempre las indicaciones de tu m√©dico.</p>
                <button id="closeModalButton" class="mt-6 w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300 transition-all">Entendido</button>
            </div>
        </div>
        <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4 z-50 hidden opacity-0 transition-opacity duration-300">
            <div class="bg-white rounded-3xl shadow-2xl p-8 text-center max-w-sm w-full">
                <img src="https://placehold.co/120x120/fecaca/ef4444?text=Oh-oh" alt="Gatito Triste" class="mx-auto mb-4 rounded-full">
                <h2 class="text-2xl kawaii-font text-red-600 mb-2">¬°Miau-problema!</h2>
                <p id="errorMessage" class="text-gray-600">Por favor, rellena todos los campos con valores correctos.</p>
                <button id="closeErrorModalButton" class="mt-6 w-full bg-red-500 text-white py-3 rounded-xl font-bold hover:bg-red-600 transition-all">Intentar de nuevo</button>
            </div>
        </div>
        <div id="calendarModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4 z-50 hidden opacity-0 transition-opacity duration-300">
            <div class="bg-white rounded-3xl shadow-2xl p-6 max-w-sm w-full space-y-4">
                 <div class="flex justify-between items-center">
                    <button id="prevMonth" class="p-2 rounded-full hover:bg-gray-100">&lt;</button>
                    <h2 id="monthAndYear" class="kawaii-font text-xl text-gray-700"></h2>
                    <button id="nextMonth" class="p-2 rounded-full hover:bg-gray-100">&gt;</button>
                </div>
                <div id="calendarGrid" class="grid grid-cols-7 gap-1 text-center"></div>
                <div class="text-center">
                    <button id="closeCalendarButton" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-xl font-bold hover:bg-gray-300">Cerrar</button>
                </div>
            </div>
        </div>
        <!-- Gemini Insight Modal -->
        <div id="geminiInsightModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4 z-50 hidden opacity-0 transition-opacity duration-300">
            <div class="bg-white rounded-3xl shadow-2xl p-6 max-w-sm w-full space-y-4">
                 <div class="text-center">
                    <img src="https://placehold.co/120x120/fed7aa/f97316?text=‚ú®" alt="Gatito M√°gico" class="mx-auto mb-4 rounded-full">
                    <h2 class="kawaii-font text-2xl text-gray-800">Tu Resumen M√°gico</h2>
                 </div>
                 <div id="geminiInsightContent" class="text-gray-600 bg-orange-50 p-4 rounded-lg text-center min-h-[100px]">
                    <!-- Gemini's response will go here -->
                 </div>
                 <button id="closeGeminiModalButton" class="w-full bg-orange-400 text-white py-3 rounded-xl font-bold hover:bg-orange-500 transition-all">¬°Entendido!</button>
            </div>
        </div>
    </div>

    <script>
        // --- DYNAMIC PWA SETUP (ROBUST VERSION) ---
        window.onload = () => {
            // 1. Create Manifest dynamically using a Data URL
            const manifest = {
                "name": "GlucoGatito: Diario de Insulina",
                "short_name": "GlucoGatito",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#fff1f2",
                "theme_color": "#f87171",
                "description": "Una adorable calculadora de insulina y diario de comidas.",
                "icons": [
                    { "src": "https://placehold.co/192x192/fca5a5/dc2626?text=üíï", "sizes": "192x192", "type": "image/png" },
                    { "src": "https://placehold.co/512x512/fca5a5/dc2626?text=üíï", "sizes": "512x512", "type": "image/png" }
                ]
            };
            const manifestString = JSON.stringify(manifest);
            const manifestUrl = `data:application/manifest+json,${encodeURIComponent(manifestString)}`;
            const linkEl = document.createElement('link');
            linkEl.rel = 'manifest';
            linkEl.href = manifestUrl;
            document.head.appendChild(linkEl);

            // 2. Register Service Worker using a Data URL
            if ('serviceWorker' in navigator) {
                const swCode = `
                    const CACHE_NAME = 'glucogatito-cache-v1';
                    self.addEventListener('install', event => console.log('Service Worker: Installing...'));
                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            fetch(event.request).catch(() => caches.match(event.request))
                        );
                    });
                `;
                const swUrl = `data:application/javascript,${encodeURIComponent(swCode)}`;
                navigator.serviceWorker.register(swUrl)
                    .then(registration => console.log('ServiceWorker registration successful'))
                    .catch(error => console.log('ServiceWorker registration failed: ', error));
            }
        };


        // --- App Logic ---
        let currentDate = new Date();
        let currentFoodBreakdown = [];
        const getEl = (id) => document.getElementById(id);

        const currentGlucoseEl = getEl('currentGlucose'), targetGlucoseEl = getEl('targetGlucose'),
              correctionFactorEl = getEl('correctionFactor'), carbRatioEl = getEl('carbRatio'),
              carbsToEatEl = getEl('carbsToEat'), caloriesEl = getEl('calories'),
              foodSearchEl = getEl('foodSearch'), mealTypeEl = getEl('mealType'),
              activityInput = getEl('activityInput'), dailyLogEl = getEl('dailyLog'),
              activityLogEl = getEl('activityLog'), totalCaloriesEl = getEl('totalCalories');

        const calculateButton = getEl('calculateButton'), searchButton = getEl('searchButton'),
              addActivityButton = getEl('addActivityButton');

        const resultModal = getEl('resultModal'), resultCard = getEl('resultCard'),
              resultText = getEl('resultText'), resultMessage = getEl('resultMessage'),
              resultImage = getEl('resultImage'), closeModalButton = getEl('closeModalButton');
        
        const errorModal = getEl('errorModal'), errorMessage = getEl('errorMessage'),
              closeErrorModalButton = getEl('closeErrorModalButton');

        const calendarModal = getEl('calendarModal'), openCalendarButton = getEl('openCalendarButton'),
              closeCalendarButton = getEl('closeCalendarButton'), monthAndYear = getEl('monthAndYear'),
              calendarGrid = getEl('calendarGrid'), prevMonth = getEl('prevMonth'), nextMonth = getEl('nextMonth');
        
        const searchIcon = getEl('searchIcon'), searchLoadingIcon = getEl('searchLoadingIcon'),
              foodBreakdownEl = getEl('foodBreakdown');

        const analyzeDayButton = getEl('analyzeDayButton'), analyzeButtonText = getEl('analyzeButtonText'),
              sparkleIcon = getEl('sparkleIcon'), analyzeLoadingIcon = getEl('analyzeLoadingIcon'),
              geminiInsightModal = getEl('geminiInsightModal'), geminiInsightContent = getEl('geminiInsightContent'),
              closeGeminiModalButton = getEl('closeGeminiModalButton');

        const getDb = () => JSON.parse(localStorage.getItem('kawaiiInsulinLog')) || {};
        const saveDb = (db) => localStorage.setItem('kawaiiInsulinLog', JSON.stringify(db));
        const getDateKey = (date) => date.toISOString().split('T')[0];

        const showModal = (modal) => {
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.replace('opacity-0', 'opacity-100'), 10);
        };
        const hideModal = (modal) => {
            modal.classList.replace('opacity-100', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        };
        
        const setAnalyzeLoading = (isLoading) => {
            analyzeButtonText.classList.toggle('hidden', isLoading);
            sparkleIcon.classList.toggle('hidden', isLoading);
            analyzeLoadingIcon.classList.toggle('hidden', !isLoading);
            analyzeDayButton.disabled = isLoading;
            analyzeDayButton.classList.toggle('cursor-not-allowed', isLoading);
        };
        
        const setSearchLoading = (isLoading) => {
            searchIcon.classList.toggle('hidden', isLoading);
            searchLoadingIcon.classList.toggle('hidden', !isLoading);
            searchButton.disabled = isLoading;
        };

        function logMealAndCalculate() {
            const currentGlucose = parseFloat(currentGlucoseEl.value);
            const targetGlucose = parseFloat(targetGlucoseEl.value);
            const correctionFactor = parseFloat(correctionFactorEl.value);
            const carbRatio = parseFloat(carbRatioEl.value);
            const carbsToEat = parseFloat(carbsToEatEl.value);
            const calories = parseFloat(caloriesEl.value) || 0;
            const food = foodSearchEl.value.trim();
            const mealType = mealTypeEl.value;
            let correctionDose = 0, carbDose = 0;
            const isValidCorrection = !isNaN(currentGlucose) && !isNaN(targetGlucose) && !isNaN(correctionFactor) && correctionFactor > 0;
            const isValidMeal = !isNaN(carbsToEat) && carbsToEat >= 0 && !isNaN(carbRatio) && carbRatio > 0;

            if (isValidMeal && !food) { showError('A√±ade una descripci√≥n de la comida si registras carbohidratos.'); return; }
            if (!isValidCorrection && !isValidMeal) { showError('Rellena los datos para correcci√≥n y/o para una comida.'); return; }
            if (isValidCorrection) correctionDose = (currentGlucose - targetGlucose) / correctionFactor;
            if (isValidMeal && carbsToEat > 0) carbDose = carbsToEat / carbRatio;
            let totalDose = Math.max(0, correctionDose + carbDose);
            const logFoodName = food || "Correcci√≥n de Glucosa";
            const logMealType = food ? mealType : "Correcci√≥n";
            
            if (totalDose > 0 || isValidMeal) {
                const db = getDb(), key = getDateKey(new Date());
                if (!db[key]) db[key] = { meals: [], activities: [] };
                db[key].meals.push({
                    id: Date.now(),
                    time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                    food: logFoodName, carbs: carbsToEat || 0, calories, mealType: logMealType, 
                    dose: totalDose.toFixed(1), breakdown: currentFoodBreakdown
                });
                saveDb(db);
            }
            renderDailyLog(new Date());
            showResult(totalDose.toFixed(1));
            clearInputs();
        }
        
        function logActivity() {
            const activityText = activityInput.value.trim();
            if(!activityText) return;
            const db = getDb(), key = getDateKey(new Date());
            if (!db[key]) db[key] = { meals: [], activities: [] };
            db[key].activities.push({ id: Date.now(), text: activityText });
            saveDb(db);
            renderDailyLog(new Date());
            activityInput.value = '';
        }

        async function findCarbs() {
            const foodQuery = foodSearchEl.value.trim();
            if (!foodQuery) { showError('Escribe un alimento para buscar.'); return; }
            setSearchLoading(true);
            foodBreakdownEl.innerHTML = '';
            currentFoodBreakdown = [];
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const systemPrompt = `Eres un asistente de nutrici√≥n. Analiza la comida y devuelve un array de objetos JSON: [{"foodName": "nombre", "carbohydrates": numero, "calories": numero}]. Por ejemplo, para '1 pl√°tano y 2 tostadas', responde: [{"foodName": "1 pl√°tano", "carbohydrates": 27, "calories": 105}, {"foodName": "2 tostadas", "carbohydrates": 26, "calories": 140}]. Solo JSON.`;
            const payload = { contents: [{ parts: [{ text: foodQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, };

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`Error API: ${response.statusText}`);
                const result = await response.json();
                let textResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!textResponse) throw new Error('Respuesta de IA inv√°lida.');
                textResponse = textResponse.replace(/^```json\s*/, '').replace(/```$/, '');
                const data = JSON.parse(textResponse);
                if (!Array.isArray(data)) throw new Error('La respuesta no es un array.');
                currentFoodBreakdown = data;
                const totals = data.reduce((acc, item) => {
                    acc.carbs += (item.carbohydrates || 0);
                    acc.calories += (item.calories || 0);
                    return acc;
                }, { carbs: 0, calories: 0 });
                carbsToEatEl.value = totals.carbs.toFixed(1);
                caloriesEl.value = totals.calories.toFixed(0);
                renderFoodBreakdown(data);
                [carbsToEatEl, caloriesEl].forEach(el => {
                    el.classList.add('flash-success');
                    setTimeout(() => el.classList.remove('flash-success'), 800);
                });
            } catch (error) {
                console.error('Error fetching carbs:', error);
                showError("No pude obtener los datos. Intenta ser m√°s espec√≠fico.");
            } finally {
                setSearchLoading(false);
            }
        }

        async function analyzeDayWithGemini() {
            const key = getDateKey(new Date());
            const dayData = getDb()[key] || { meals: [], activities: [] };
            if (dayData.meals.length === 0 && dayData.activities.length === 0) {
                showError("A√∫n no hay datos para analizar hoy."); return;
            }
            setAnalyzeLoading(true);
            let promptData = "Resumen del d√≠a:\n";
            if(dayData.meals.length > 0) promptData += "Comidas:\n" + dayData.meals.map(m => `- ${m.mealType}: ${m.food} (${m.carbs}g CH, ${m.calories} kcal)`).join("\n");
            if(dayData.activities.length > 0) promptData += "\n\nActividades:\n" + dayData.activities.map(a => `- ${a.text}`).join("\n");
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const systemPrompt = `Eres un coach de diabetes 'kawaii'. NO das consejos m√©dicos. Analiza los datos y da un resumen corto (1-2 frases) y un consejo gentil (1 frase) para ma√±ana. Usa emojis como üíñ, ‚ú®, üå∏. S√© breve y cari√±osa. Termina recordando que no es un consejo m√©dico.`;
            const payload = { contents: [{ parts: [{ text: promptData }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, };

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`Error API: ${response.statusText}`);
                const result = await response.json();
                const textResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (textResponse) {
                    geminiInsightContent.innerHTML = textResponse.replace(/\n/g, '<br>');
                    showModal(geminiInsightModal);
                } else { throw new Error('No se pudo obtener respuesta.'); }
            } catch (error) {
                console.error('Error with Gemini analysis:', error);
                showError("Miau... No pude contactar a mi amigo m√°gico.");
            } finally {
                setAnalyzeLoading(false);
            }
        }
        
        function renderFoodBreakdown(breakdown) {
            if (breakdown.length <= 1) { foodBreakdownEl.innerHTML = ''; return; }
            foodBreakdownEl.innerHTML = `<p class="text-xs font-bold text-gray-600 mb-1">Desglose:</p>` +
                breakdown.map(item => `<div class="flex justify-between items-center bg-white/60 p-1 rounded"><span class="text-gray-700">${item.foodName}</span><span class="text-gray-500 font-medium">${(item.carbohydrates || 0).toFixed(1)}g CH / ${(item.calories || 0).toFixed(0)}kcal</span></div>`).join('');
        }

        function renderDailyLog(date) {
            const key = getDateKey(date);
            const dayData = getDb()[key] || { meals: [], activities: [] };
            dailyLogEl.innerHTML = dayData.meals.length === 0 ? `<li class="text-center text-gray-500 p-4">A√∫n no hay comidas.</li>` : 
                dayData.meals.map(meal => {
                    let breakdownHtml = '';
                    if (meal.breakdown && meal.breakdown.length > 1) {
                        breakdownHtml = `<ul class="text-xs text-gray-500 pl-4 mt-1 list-disc list-inside">` + meal.breakdown.map(item => `<li>${item.foodName}: ${(item.carbohydrates || 0).toFixed(1)}g CH, ${(item.calories || 0).toFixed(0)}kcal</li>`).join('') + `</ul>`;
                    }
                    let detailsParts = [];
                    if (meal.carbs > 0) detailsParts.push(`${meal.carbs.toFixed(1)}g CH`);
                    if (meal.calories > 0) detailsParts.push(`${meal.calories.toFixed(0)} kcal`);
                    if (parseFloat(meal.dose) > 0) detailsParts.push(`<span class="text-red-600 font-medium">${meal.dose} U</span>`);
                    return `<li class="bg-red-50 p-3 rounded-lg"><div class="flex justify-between items-start"><div><p class="font-bold text-gray-800">${meal.mealType}: <span class="font-normal">${meal.food}</span></p><p class="text-sm text-gray-600">${detailsParts.join(' ¬∑ ')}</p></div><span class="text-xs text-gray-400 shrink-0 ml-2">${meal.time}</span></div>${breakdownHtml}</li>`;
                }).join('');
            activityLogEl.innerHTML = dayData.activities.map(activity => `<li class="bg-orange-50 p-2 rounded-md flex items-center gap-2"><span>üü†</span> <span class="flex-1">${activity.text}</span></li>`).join('');
            totalCaloriesEl.textContent = dayData.meals.reduce((sum, meal) => sum + (meal.calories || 0), 0).toFixed(0);
        }
        
        function renderCalendar() {
            calendarGrid.innerHTML = '';
            const month = currentDate.getMonth(), year = currentDate.getFullYear();
            monthAndYear.textContent = new Date(year, month).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            const firstDay = new Date(year, month, 1).getDay(), daysInMonth = new Date(year, month + 1, 0).getDate();
            const dayOffset = (firstDay === 0) ? 6 : firstDay - 1;
            const db = getDb();
            ['Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sa', 'Do'].forEach(day => { calendarGrid.innerHTML += `<div class="font-bold text-gray-500 text-sm">${day}</div>`; });
            for(let i = 0; i < dayOffset; i++) calendarGrid.appendChild(document.createElement('div'));
            for(let i = 1; i <= daysInMonth; i++) {
                const dayEl = document.createElement('div'), date = new Date(year, month, i), dateKey = getDateKey(date);
                dayEl.className = 'p-2 rounded-full cursor-pointer relative calendar-day';
                dayEl.textContent = i;
                if (db[dateKey] && (db[dateKey].meals.length > 0 || db[dateKey].activities.length > 0)) dayEl.classList.add('has-entry');
                if (getDateKey(new Date()) === dateKey) dayEl.classList.add('bg-red-500', 'text-white');
                dayEl.addEventListener('click', () => {
                    const mealsText = (db[dateKey]?.meals || []).map(m => `- ${m.mealType}: ${m.food}`).join('\n') || 'Ninguna';
                    const activitiesText = (db[dateKey]?.activities || []).map(a => `- ${a.text}`).join('\n') || 'Ninguna';
                    const logContent = `Registros para ${date.toLocaleDateString('es-ES')}:\n\nComidas:\n${mealsText}\n\nActividades:\n${activitiesText}`;
                    const alertModal = document.createElement('div');
                    alertModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
                    alertModal.innerHTML = `<div class="bg-white rounded-2xl p-6 max-w-sm w-full"><h3 class="font-bold text-lg mb-2">Registros del d√≠a</h3><pre class="bg-gray-100 p-3 rounded-lg whitespace-pre-wrap text-sm">${logContent}</pre><button class="mt-4 w-full bg-gray-200 text-gray-700 py-2 rounded-lg font-bold">Cerrar</button></div>`;
                    document.body.appendChild(alertModal);
                    alertModal.querySelector('button').onclick = () => alertModal.remove();
                });
                calendarGrid.appendChild(dayEl);
            }
        }

        function showResult(dose) {
            resultText.textContent = `${dose} U`;
            resultImage.src = dose > 0 ? 'https://placehold.co/120x120/fed7aa/f97316?text=Miau%21' : 'https://placehold.co/120x120/fff7ed/fb923c?text=Zzz...';
            resultMessage.textContent = '¬°Registro guardado! Sigue siempre las indicaciones de tu m√©dico.';
            showModal(resultModal);
        }

        function showError(message) { errorMessage.textContent = message; showModal(errorModal); }
        function clearInputs() {
            currentGlucoseEl.value = ''; carbsToEatEl.value = ''; caloriesEl.value = ''; 
            foodSearchEl.value = ''; foodBreakdownEl.innerHTML = ''; currentFoodBreakdown = [];
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => renderDailyLog(new Date()));
        calculateButton.addEventListener('click', logMealAndCalculate);
        addActivityButton.addEventListener('click', logActivity);
        searchButton.addEventListener('click', findCarbs);
        foodSearchEl.addEventListener('keypress', (e) => e.key === 'Enter' && findCarbs());
        activityInput.addEventListener('keypress', (e) => e.key === 'Enter' && logActivity());
        analyzeDayButton.addEventListener('click', analyzeDayWithGemini);
        
        [closeModalButton, resultModal].forEach(el => el.addEventListener('click', () => hideModal(resultModal)));
        [closeErrorModalButton, errorModal].forEach(el => el.addEventListener('click', () => hideModal(errorModal)));
        [closeGeminiModalButton, geminiInsightModal].forEach(el => el.addEventListener('click', () => hideModal(geminiInsightModal)));
        [resultCard, getEl('geminiInsightModal').querySelector('div'), errorModal.querySelector('div'), calendarModal.querySelector('div')].forEach(card => card.addEventListener('click', (e) => e.stopPropagation()));
        
        openCalendarButton.addEventListener('click', () => { currentDate = new Date(); renderCalendar(); showModal(calendarModal); });
        closeCalendarButton.addEventListener('click', () => hideModal(calendarModal));
        prevMonth.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
        nextMonth.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
    </script>
</body>
</html>
